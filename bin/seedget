#!/bin/sh

set -e

limit=292K
path=data
nagle_enabled=1
verbosity=0

while getopts ":l:pcdNv" opt; do
	case $opt in
		l ) limit=$OPTARG;;
		p ) pretend=n;;
		c ) checksum=c;;
		d ) path=downloads;;
		N ) nagle_enabled=0;;
		v ) verbosity=$(($verbosity + 1));;
		: ) echo "-$OPTARG requires an argument" >&2; exit 1;;
		\?) echo "Invalid option: -$OPTARG" >&2; exit 1;;
	esac
done

shift $(($OPTIND - 1))

if [ $verbosity -eq 2 ]; then
	verbose=v
elif [ $verbosity -gt 2 ]; then
	verbose=vv
fi

[ $nagle_enabled -eq 1 ] && nagle="-e 'ssh -o \"ProxyCommand nc %h %p\"' "

command="rsync -avhP$pretend$checksum$verbose $nagle--bwlimit=$limit --timeout=20"

for pattern in "$@"; do
	command="$command 'jimbo:torrent/$path/$pattern'"
done

command="$command ."

[ $verbosity -ge 1 ] && echo $command

until eval $command; do
	[ $? -ne 20 ] || exit 1
	sleep 120
done
