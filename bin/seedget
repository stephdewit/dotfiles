#!/bin/sh

set -e

limit=292K
path=data

while getopts ":l:pcd" opt; do
	case $opt in
		l ) limit=$OPTARG;;
		p ) pretend=n;;
		c ) checksum=c;;
		d ) path=downloads;;
		: ) echo "-$OPTARG requires an argument" >&2; exit 1;;
		\?) echo "Invalid option: -$OPTARG" >&2; exit 1;;
	esac
done

shift $(($OPTIND - 1))

command="rsync -avhP$pretend$checksum --bwlimit=$limit --timeout=20"

for pattern in "$@"; do
	command="$command 'jimbo-with-nagle:torrent/$path/$pattern'"
done

command="$command ."

until eval $command; do
	[ $? -ne 20 ] || exit 1
	sleep 120
done
